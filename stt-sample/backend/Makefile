# Makefile - í”„ë¡œì íŠ¸ ìë™í™”

.PHONY: help install deploy quick-deploy update-deps test run clean setup-streamlit check-deploy

# ê¸°ë³¸ ëª…ë ¹ì–´ (help)
help:
	@echo "ï¿½ï¿½ ë©€í‹°ëª¨ë‹¬ RAG - ìë™í™” ëª…ë ¹ì–´"
	@echo "================================"
	@echo ""
	@echo "ï¿½ï¿½ ì„¤ì¹˜ ë° ì„¤ì •:"
	@echo "  make install         - í”„ë¡œì íŠ¸ ì´ˆê¸° ì„¤ì •"
	@echo "  make setup-streamlit - Streamlit Cloud ì„¤ì •"
	@echo ""
	@echo "ğŸš€ ë°°í¬:"
	@echo "  make deploy          - ì „ì²´ ë°°í¬ í”„ë¡œì„¸ìŠ¤ (ëŒ€í™”í˜•)"
	@echo "  make quick-deploy    - ë¹ ë¥¸ ë°°í¬ (ê¸°ë³¸ ë©”ì‹œì§€)"
	@echo "  make check-deploy    - ë°°í¬ ì¤€ë¹„ ìƒíƒœ í™•ì¸"
	@echo ""
	@echo "ğŸ’» ê°œë°œ:"
	@echo "  make run            - ë¡œì»¬ ì‹¤í–‰"
	@echo "  make test           - í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
	@echo "  make update-deps    - ì˜ì¡´ì„± ì—…ë°ì´íŠ¸"
	@echo "  make clean          - ìºì‹œ/ì„ì‹œ íŒŒì¼ ì •ë¦¬"

# Git ì €ì¥ì†Œ ì°¾ê¸° í•¨ìˆ˜
find-git-repo:
	@GIT_ROOT=$$(pwd); \
	while [ "$$GIT_ROOT" != "/" ]; do \
		if [ -d "$$GIT_ROOT/.git" ]; then \
			echo "$$GIT_ROOT"; \
			exit 0; \
		fi; \
		GIT_ROOT=$$(dirname "$$GIT_ROOT"); \
	done; \
	exit 1

# í”„ë¡œì íŠ¸ ì´ˆê¸° ì„¤ì •
install:
	@echo "ï¿½ï¿½ í”„ë¡œì íŠ¸ ì„¤ì • ì¤‘..."
	@if ! command -v uv &> /dev/null; then \
		echo "uv ì„¤ì¹˜ ì¤‘..."; \
		curl -LsSf https://astral.sh/uv/install.sh | sh; \
	fi
	uv venv
	uv pip sync
	@echo "âœ… ì„¤ì¹˜ ì™„ë£Œ! 'source .venv/bin/activate'ë¡œ ê°€ìƒí™˜ê²½ í™œì„±í™”"

# Streamlit Cloud ì´ˆê¸° ì„¤ì •
setup-streamlit:
	@echo "â˜ï¸ Streamlit Cloud ì„¤ì • íŒŒì¼ ìƒì„± ì¤‘..."
	@# packages.txt ìƒì„±
	@echo "ffmpeg" > packages.txt
	@echo "libsndfile1" >> packages.txt
	@echo "build-essential" >> packages.txt
	@echo "python3-dev" >> packages.txt
	@echo "git" >> packages.txt
	@echo "âœ… packages.txt ìƒì„± ì™„ë£Œ"
	
	@# .streamlit ë””ë ‰í† ë¦¬ ë° config.toml ìƒì„±
	@mkdir -p .streamlit
	@echo "[theme]" > .streamlit/config.toml
	@echo 'primaryColor = "#FF4B4B"' >> .streamlit/config.toml
	@echo 'backgroundColor = "#FFFFFF"' >> .streamlit/config.toml
	@echo 'secondaryBackgroundColor = "#F0F2F6"' >> .streamlit/config.toml
	@echo 'textColor = "#262730"' >> .streamlit/config.toml
	@echo 'font = "sans serif"' >> .streamlit/config.toml
	@echo "" >> .streamlit/config.toml
	@echo "[server]" >> .streamlit/config.toml
	@echo "maxUploadSize = 50" >> .streamlit/config.toml
	@echo "enableCORS = false" >> .streamlit/config.toml
	@echo "" >> .streamlit/config.toml
	@echo "[browser]" >> .streamlit/config.toml
	@echo "gatherUsageStats = false" >> .streamlit/config.toml
	@echo "âœ… .streamlit/config.toml ìƒì„± ì™„ë£Œ"
	
	@# .gitignore ìƒì„±/ì—…ë°ì´íŠ¸
	@if [ ! -f .gitignore ]; then \
		echo "# Python" > .gitignore; \
		echo "__pycache__/" >> .gitignore; \
		echo "*.py[cod]" >> .gitignore; \
		echo ".venv/" >> .gitignore; \
		echo "" >> .gitignore; \
		echo "# Environment" >> .gitignore; \
		echo ".env" >> .gitignore; \
		echo ".streamlit/secrets.toml" >> .gitignore; \
		echo "" >> .gitignore; \
		echo "# IDE" >> .gitignore; \
		echo ".vscode/" >> .gitignore; \
		echo ".idea/" >> .gitignore; \
		echo ".DS_Store" >> .gitignore; \
		echo "" >> .gitignore; \
		echo "# UV" >> .gitignore; \
		echo ".uv/" >> .gitignore; \
		echo "uv.lock" >> .gitignore; \
		echo "" >> .gitignore; \
		echo "# Data" >> .gitignore; \
		echo "data/" >> .gitignore; \
		echo "*.mp3" >> .gitignore; \
		echo "*.wav" >> .gitignore; \
		echo "âœ… .gitignore ìƒì„± ì™„ë£Œ"; \
	fi

# requirements.txt ìƒì„±
requirements:
	@echo "ğŸ“‹ requirements.txt ìƒì„± ì¤‘..."
	@uv pip compile pyproject.toml --no-deps -q > requirements_temp.txt

	@{ \
	  echo "# Auto-generated from pyproject.toml"; \
	  echo "# Generated at: $$(date -u +'%Y-%m-%dT%H:%M:%SZ')"; \
	  echo; \
	  echo "# Torch CPU version for Streamlit Cloud"; \
	  echo "--find-links https://download.pytorch.org/whl/torch_stable.html"; \
	  echo "torch==2.3.1+cpu"; \
	  echo; \
	  echo "# Audio processing dependencies"; \
	  echo "openai-whisper==20240930"; \
	  echo "pydub==0.25.1"; \
	  echo "numpy==2.3.2"; \
	  echo; \
	  echo "# Other dependencies"; \
	} > requirements.txt

	# ì¤‘ë³µ ì œê±°: ìœ„ì—ì„œ ê³ ì •í•œ íŒ¨í‚¤ì§€ë“¤ì€ tempì—ì„œ ì œì™¸
	@grep -Ev '^(torch==|openai-whisper==|pydub==|numpy==)' requirements_temp.txt >> requirements.txt
	@rm -f requirements_temp.txt
	@echo "âœ… requirements.txt ìƒì„± ì™„ë£Œ"
requirements-faster:
	@echo "ğŸ“‹ requirements.txt(faster-whisper) ìƒì„± ì¤‘..."
	@uv pip compile pyproject.toml --no-deps -q > requirements_temp.txt

	@{ \
	  echo "# Auto-generated from pyproject.toml (faster-whisper)"; \
	  echo "# Generated at: $$(date -u +'%Y-%m-%dT%H:%M:%SZ')"; \
	  echo; \
	  echo "# Audio processing (CTranslate2 backend)"; \
	  echo "faster-whisper==1.0.2"; \
	  echo "pydub==0.25.1"; \
	  echo "numpy==2.3.2"; \
	  echo; \
	  echo "# Other dependencies"; \
	} > requirements.txt

	@grep -Ev '^(torch==|openai-whisper==|faster-whisper==|pydub==|numpy==)' requirements_temp.txt >> requirements.txt
	@rm -f requirements_temp.txt
	@echo "âœ… requirements.txt(faster) ìƒì„± ì™„ë£Œ"

# ë°°í¬ ì¤€ë¹„ ìƒíƒœ í™•ì¸
check-deploy:
	@echo "ğŸ” ë°°í¬ ì¤€ë¹„ ìƒíƒœ í™•ì¸"
	@echo "====================="
	@echo ""
	@# í•„ìˆ˜ íŒŒì¼ í™•ì¸
	@echo "ğŸ“ í•„ìˆ˜ íŒŒì¼ í™•ì¸:"
	@[ -f "pyproject.toml" ] && echo "  âœ… pyproject.toml" || echo "  âŒ pyproject.toml"
	@[ -f "app.py" ] && echo "  âœ… app.py" || echo "  âŒ app.py"
	@[ -f "packages.txt" ] && echo "  âœ… packages.txt" || echo "  âŒ packages.txt"
	@[ -f "requirements.txt" ] && echo "  âœ… requirements.txt" || echo "  âŒ requirements.txt"
	@[ -f ".streamlit/config.toml" ] && echo "  âœ… .streamlit/config.toml" || echo "  âš ï¸  .streamlit/config.toml (ì„ íƒ)"
	@echo ""
	@# Git ìƒíƒœ í™•ì¸ (ìƒìœ„ ë””ë ‰í† ë¦¬ê¹Œì§€ ê²€ìƒ‰)
	@echo "ğŸ“Š Git ìƒíƒœ:"
	@GIT_ROOT=$$(pwd); \
	GIT_FOUND=false; \
	while [ "$$GIT_ROOT" != "/" ]; do \
		if [ -d "$$GIT_ROOT/.git" ]; then \
			echo "  âœ… Git ì €ì¥ì†Œ ë°œê²¬: $$GIT_ROOT"; \
			echo "  ï¿½ï¿½ í˜„ì¬ ë¸Œëœì¹˜: $$(cd "$$GIT_ROOT" && git branch --show-current)"; \
			if cd "$$GIT_ROOT" && git remote get-url origin &>/dev/null; then \
				echo "  ğŸ”— ì›ê²©: $$(cd "$$GIT_ROOT" && git remote get-url origin)"; \
			else \
				echo "  âš ï¸  ì›ê²© ì €ì¥ì†Œ ë¯¸ì„¤ì •"; \
			fi; \
			GIT_FOUND=true; \
			break; \
		fi; \
		GIT_ROOT=$$(dirname "$$GIT_ROOT"); \
	done; \
	if [ "$$GIT_FOUND" = "false" ]; then \
		echo "  âŒ Git ì €ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"; \
	fi
	@echo ""
	@# í™˜ê²½ ë³€ìˆ˜ í™•ì¸
	@echo "ğŸ” í™˜ê²½ ì„¤ì •:"
	@[ -f ".env" ] && echo "  âš ï¸  .env íŒŒì¼ ì¡´ì¬ (gitignore í™•ì¸)" || echo "  âœ… .env íŒŒì¼ ì—†ìŒ"
	@echo ""
	@if [ -f "requirements.txt" ] && [ -f "packages.txt" ] && [ -f "app.py" ]; then \
		echo "âœ… ë°°í¬ ì¤€ë¹„ ì™„ë£Œ!"; \
	else \
		echo "âŒ ë°°í¬ ì¤€ë¹„ ë¯¸ì™„ë£Œ. 'make setup-streamlit' ì‹¤í–‰ í•„ìš”"; \
	fi

# ì „ì²´ ë°°í¬ í”„ë¡œì„¸ìŠ¤
deploy: requirements
	@echo ""
	@echo "ï¿½ï¿½ ë°°í¬ í”„ë¡œì„¸ìŠ¤ ì‹œì‘..."
	@# Git ì €ì¥ì†Œ ì°¾ê¸°
	@GIT_ROOT=$$(pwd); \
	GIT_FOUND=false; \
	while [ "$$GIT_ROOT" != "/" ]; do \
		if [ -d "$$GIT_ROOT/.git" ]; then \
			GIT_FOUND=true; \
			break; \
		fi; \
		GIT_ROOT=$$(dirname "$$GIT_ROOT"); \
	done; \
	if [ "$$GIT_FOUND" = "false" ]; then \
		echo "âŒ Git ì €ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. 'git init'ì„ ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”."; \
		exit 1; \
	fi; \
	echo "âœ… Git ì €ì¥ì†Œ ë°œê²¬: $$GIT_ROOT"; \
	\
	# Streamlit Cloudìš© íŒŒì¼ë“¤ì„ ë£¨íŠ¸ì— ë³µì‚¬
	echo "ğŸ“ Streamlit Cloudìš© íŒŒì¼ ë³µì‚¬ ì¤‘..."; \
	cp packages.txt "$$GIT_ROOT/"; \
	cp requirements.txt "$$GIT_ROOT/"; \
	cp app.py "$$GIT_ROOT/streamlit_app.py"; \
	echo "âœ… íŒŒì¼ ë³µì‚¬ ì™„ë£Œ"; \
	\
	cd "$$GIT_ROOT" && git add . && git commit -m "Deploy: $$(date '+%Y-%m-%d %H:%M:%S')" && git push -u origin $$(git branch --show-current); \
	echo ""; \
	echo "âœ… ë°°í¬ ì™„ë£Œ!"; \
	echo "ğŸ”— Streamlit Cloudì—ì„œ ë°°í¬: https://share.streamlit.io"

# ë¹ ë¥¸ ë°°í¬ (ê¸°ë³¸ ì»¤ë°‹ ë©”ì‹œì§€)
quick-deploy: requirements
	@echo "âš¡ ë¹ ë¥¸ ë°°í¬ ëª¨ë“œ"
	@# Git ì €ì¥ì†Œ ì°¾ê¸°
	@GIT_ROOT=$$(pwd); \
	GIT_FOUND=false; \
	while [ "$$GIT_ROOT" != "/" ]; do \
		if [ -d "$$GIT_ROOT/.git" ]; then \
			GIT_FOUND=true; \
			break; \
		fi; \
		GIT_ROOT=$$(dirname "$$GIT_ROOT"); \
	done; \
	if [ "$$GIT_FOUND" = "false" ]; then \
		echo "âŒ Git ì €ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."; \
		exit 1; \
	fi; \
	cd "$$GIT_ROOT" && git add . && git commit -m "Quick deploy: $$(date '+%Y-%m-%d %H:%M:%S')" && git push -u origin $$(git branch --show-current); \
	echo ""; \
	echo "âœ… í‘¸ì‹œ ì™„ë£Œ!"; \
	echo "ğŸ”— Streamlit Cloudì—ì„œ ë°°í¬: https://share.streamlit.io"

# ì˜ì¡´ì„± ì—…ë°ì´íŠ¸
update-deps:
	@echo "ï¿½ï¿½ ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ ì¤‘..."
	uv pip sync
	@$(MAKE) requirements
	@echo "âœ… ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ ì™„ë£Œ"

# ë¡œì»¬ ì‹¤í–‰
run:
	@echo "ğŸ–¥ï¸  ë¡œì»¬ ì„œë²„ ì‹œì‘..."
	@if [ ! -f ".venv/bin/activate" ]; then \
		echo "âš ï¸  ê°€ìƒí™˜ê²½ì´ ì—†ìŠµë‹ˆë‹¤. 'make install' ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”."; \
		exit 1; \
	fi
	uv run streamlit run app.py

# í…ŒìŠ¤íŠ¸ ì‹¤í–‰
test:
	@echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
	@if [ -d "tests" ]; then \
		uv run pytest tests/ -v; \
	else \
		echo "âš ï¸  tests ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤."; \
	fi

# ì •ë¦¬
clean:
	@echo "ğŸ§¹ ì •ë¦¬ ì¤‘..."
	@find . -type d -name "__pycache__" -exec rm -r {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@rm -rf .pytest_cache 2>/dev/null || true
	@rm -rf .coverage htmlcov 2>/dev/null || true
	@rm -rf data/cache/* 2>/dev/null || true
	@rm -f requirements_temp.txt 2>/dev/null || true
	@echo "âœ… ì •ë¦¬ ì™„ë£Œ"

# Git ì´ˆê¸°í™” (ìƒˆ í”„ë¡œì íŠ¸ìš©)
git-init:
	@echo "ï¿½ï¿½ï¸ Git ì €ì¥ì†Œ ì´ˆê¸°í™”..."
	# @git init
	@git add .
	@git commit -m "Initial commit"
	@echo ""
	@echo "GitHub ì €ì¥ì†Œë¥¼ ìƒì„±í•œ í›„:"
	@echo "  git remote add origin https://github.com/USERNAME/REPO.git"
	@echo "  git push -u origin main"

# ì „ì²´ ì´ˆê¸° ì„¤ì • (ìƒˆ í”„ë¡œì íŠ¸)
init: install setup-streamlit git-init
	@echo ""
	@echo "ğŸ‰ í”„ë¡œì íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ!"
	@echo ""
	@echo "ë‹¤ìŒ ë‹¨ê³„:"
	@echo "1. GitHubì— ì €ì¥ì†Œ ìƒì„±"
	@echo "2. git remote add origin [URL]"
	@echo "3. make deploy"

# ë°°í¬ í›„ ìƒíƒœ í™•ì¸
post-deploy:
	@echo "ï¿½ï¿½ ë°°í¬ í›„ ì²´í¬ë¦¬ìŠ¤íŠ¸"
	@echo "==================="
	@echo ""
	@echo "1. â˜ï¸  Streamlit Cloud ëŒ€ì‹œë³´ë“œ í™•ì¸"
	@echo "   https://share.streamlit.io"
	@echo ""
	@echo "2. ğŸ” Secrets ì„¤ì • í™•ì¸"
	@echo "   - OPENAI_API_KEY"
	@echo "   - WHISPER_MODEL_SIZE (tiny ê¶Œì¥)"
	@echo "   - MAX_FILE_SIZE_MB"
	@echo ""
	@echo "3. ğŸ“± ì•± í…ŒìŠ¤íŠ¸"
	@echo "   - íŒŒì¼ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸"
	@echo "   - ìŒì„± ë³€í™˜ í…ŒìŠ¤íŠ¸"
	@echo "   - ìš”ì•½ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸"
	@echo ""
	@echo "4. ï¿½ï¿½ ëª¨ë‹ˆí„°ë§"
	@echo "   - ë¡œê·¸ í™•ì¸"
	@echo "   - ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸"
	@echo "   - ì—ëŸ¬ ì¶”ì "
